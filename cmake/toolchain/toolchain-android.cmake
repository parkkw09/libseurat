set(CMAKE_ANDROID_NDK "$ENV{NDK_R13}")

if(NOT CMAKE_ANDROID_NDK)
    find_program(ANDROID_NDK_BUILD_PROGRAM ndk-build)
    if(NOT ANDROID_NDK_BUILD_PROGRAM)
        message(FATAL_ERROR "Cannot find 'ndk-build', make sure you installed the NDK and added it to your PATH")
    endif()
    get_filename_component(CMAKE_ANDROID_NDK "${ANDROID_NDK_BUILD_PROGRAM}" DIRECTORY)
endif()

message(STATUS "LEONARDO_ARCH = ${LEONARDO_ARCH}")

set(CMAKE_SYSTEM_NAME "Android")
set(CMAKE_ANDROID_STL_TYPE "gnustl_static")

if(LEONARDO_ARCH STREQUAL "x86")
    set(CMAKE_SYSTEM_VERSION 16)
    set(CMAKE_ANDROID_API 16)
    set(CMAKE_ANDROID_ARCH "x86")
    set(CMAKE_ANDROID_ARCH_ABI "x86")
    set(CMAKE_ANDROID_NDK_TOOLCHAIN_VERSION "4.9")
elseif(LEONARDO_ARCH STREQUAL "x86_64")
    set(CMAKE_SYSTEM_VERSION 21)
    set(CMAKE_ANDROID_API 21)
    set(CMAKE_ANDROID_ARCH "x86_64")
    set(CMAKE_ANDROID_ARCH_ABI "x86_64")
    set(CMAKE_ANDROID_NDK_TOOLCHAIN_VERSION "4.9")
elseif(LEONARDO_ARCH STREQUAL "armeabi-v7a")
    set(CMAKE_SYSTEM_VERSION 16)
    set(CMAKE_ANDROID_API 16)
    set(CMAKE_ANDROID_ARCH "arm")
    set(CMAKE_ANDROID_ARCH_ABI "armeabi-v7a")
    set(CMAKE_ANDROID_NDK_TOOLCHAIN_VERSION "4.9")
elseif(LEONARDO_ARCH STREQUAL "arm64-v8a")
    set(CMAKE_SYSTEM_VERSION 21)
    set(CMAKE_ANDROID_API 21)
    set(CMAKE_ANDROID_ARCH "arm64")
    set(CMAKE_ANDROID_ARCH_ABI "arm64-v8a")
    set(CMAKE_ANDROID_NDK_TOOLCHAIN_VERSION "4.9")
else()
    message(FATAL_ERROR "Unknown LEONARDO_ARCH = [${LEONARDO_ARCH}]")
endif()

if(CMAKE_HOST_SYSTEM_NAME STREQUAL Linux)
    set(ANDROID_HOST_TAG linux-x86_64)
elseif(CMAKE_HOST_SYSTEM_NAME STREQUAL Darwin)
    set(ANDROID_HOST_TAG darwin-x86_64)
elseif(CMAKE_HOST_SYSTEM_NAME STREQUAL Windows)
    set(ANDROID_HOST_TAG windows-x86_64)
endif()

if(LEONARDO_ARCH STREQUAL "x86")
    set(ANDROID_GCC_TAG "x86-4.9")
    set(ANDROID_SYSROOT_TAG "arch-x86")
    set(ANDROID_API_TAG "android-16")
    set(ANDROID_TARGET_HOST "i686-linux-android")
    set(ANDROID_TARGET_HOST_API "i686-linux-android16")
elseif(LEONARDO_ARCH STREQUAL "x86_64")
    set(ANDROID_GCC_TAG "x86_64-4.9")
    set(ANDROID_SYSROOT_TAG "arch-x86_64")
    set(ANDROID_API_TAG "android-21")
    set(ANDROID_TARGET_HOST "x86_64-linux-android")
    set(ANDROID_TARGET_HOST_API "x86_64-linux-android21")
elseif(LEONARDO_ARCH STREQUAL "armeabi-v7a")
    set(ANDROID_GCC_TAG "arm-linux-androideabi-4.9")
    set(ANDROID_SYSROOT_TAG "arch-arm")
    set(ANDROID_API_TAG "android-16")
    set(ANDROID_TARGET_HOST "arm-linux-androideabi")
    set(ANDROID_TARGET_HOST_API "armv7a-linux-androideabi16")
elseif(LEONARDO_ARCH STREQUAL "arm64-v8a")
    set(ANDROID_GCC_TAG "aarch64-linux-android-4.9")
    set(ANDROID_SYSROOT_TAG "arch-arm64")
    set(ANDROID_API_TAG "android-21")
    set(ANDROID_TARGET_HOST "aarch64-linux-android")
    set(ANDROID_TARGET_HOST_API "aarch64-linux-android21")
else()
    message(FATAL_ERROR "Unknown LEONARDO_ARCH = [${LEONARDO_ARCH}]")
endif()

set(ANDROID_TOOLCHAIN_ROOT "${CMAKE_ANDROID_NDK}/toolchains/${ANDROID_GCC_TAG}/prebuilt/${ANDROID_HOST_TAG}")
set(ANDROID_SYSROOT_ROOT "${CMAKE_ANDROID_NDK}/platforms/${ANDROID_API_TAG}/${ANDROID_SYSROOT_TAG}")

message(STATUS "CMAKE_HOST_SYSTEM_NAME = [${CMAKE_HOST_SYSTEM_NAME}]")
message(STATUS "CMAKE_SYSTEM_NAME = [${CMAKE_SYSTEM_NAME}]")
message(STATUS "CMAKE_SYSTEM_VERSION = [${CMAKE_SYSTEM_VERSION}]")
message(STATUS "CMAKE_ANDROID_API = [${CMAKE_ANDROID_API}]")
message(STATUS "CMAKE_ANDROID_ARCH = [${CMAKE_ANDROID_ARCH}]")
message(STATUS "CMAKE_ANDROID_ARCH_ABI = [${CMAKE_ANDROID_ARCH_ABI}]")
message(STATUS "CMAKE_ANDROID_STL_TYPE = [${CMAKE_ANDROID_STL_TYPE}]")
message(STATUS "CMAKE_ANDROID_NDK = [${CMAKE_ANDROID_NDK}]")
message(STATUS "CMAKE_ANDROID_NDK_TOOLCHAIN_VERSION = [${CMAKE_ANDROID_NDK_TOOLCHAIN_VERSION}]")

message(STATUS "ANDROID_TOOLCHAIN_ROOT = ${ANDROID_TOOLCHAIN_ROOT}")
message(STATUS "ANDROID_SYSROOT_ROOT = ${ANDROID_SYSROOT_ROOT}")
message(STATUS "ANDROID_HOST_TAG = ${ANDROID_HOST_TAG}")

list(APPEND TOOLCHAIN_OPTIONS "-DCMAKE_SYSTEM_NAME=${CMAKE_SYSTEM_NAME}")
list(APPEND TOOLCHAIN_OPTIONS "-DCMAKE_SYSTEM_VERSION=${CMAKE_SYSTEM_VERSION}")
list(APPEND TOOLCHAIN_OPTIONS "-DCMAKE_ANDROID_ARCH_ABI=${CMAKE_ANDROID_ARCH_ABI}")
list(APPEND TOOLCHAIN_OPTIONS "-DCMAKE_ANDROID_NDK=${CMAKE_ANDROID_NDK}")
list(APPEND TOOLCHAIN_OPTIONS "-DCMAKE_ANDROID_STL_TYPE=${CMAKE_ANDROID_STL_TYPE}")

set(OUT_DIR ${CMAKE_CURRENT_SOURCE_DIR}/out/${CMAKE_ANDROID_ARCH_ABI})

list(APPEND COMMON_OPTIONS "-DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}")
list(APPEND COMMON_OPTIONS "-DCMAKE_PREFIX_PATH=${OUT_DIR}")
list(APPEND COMMON_OPTIONS "-DCMAKE_INSTALL_PREFIX=${OUT_DIR}")

message(STATUS "OUT_DIR = ${OUT_DIR}")
message(STATUS "CMAKE_BUILD_TYPE = ${CMAKE_BUILD_TYPE}")
message(STATUS "CMAKE_PREFIX_PATH = ${CMAKE_PREFIX_PATH}")
message(STATUS "CMAKE_INSTALL_PREFIX = ${CMAKE_INSTALL_PREFIX}")